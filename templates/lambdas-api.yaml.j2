---
{% import 'lambda-dict.j2' as imported %}

AWSTemplateFormatVersion: '2010-09-09'
Transform: 'AWS::Serverless-2016-10-31'

Description: 'DMPHub Lambda functions that are invoked by the API Gateway'

Parameters:
  VpcId:
    Type: 'AWS::EC2::VPC::Id'
  Subnets:
    Type: 'List<AWS::EC2::Subnet::Id>'

  Env:
    Type: 'String'
  DomainName:
    Type: 'String'
  DmpIdShoulder:
    Type: 'String'

  CodePipelineIAMRoleArn:
    Type: 'String'
  CodeBuildIAMRoleArn:
    Type: 'String'
  CodeDeployIAMRoleArn:
    Type: 'String'

  S3CodePipelineBucket:
    Type: 'String'
  S3LambdaCodeSigningBucketId:
    Type: 'String'
  S3RepositoryBucket:
    Type: 'String'

  CodeBuildSecurityGroupId:
    Type: 'String'

  # LambdaCodeSigningConfigArn:
  #   Type: 'String'

  CodeStarConnectionArn:
    Type: 'String'

  RepositoryBranchToMonitor:
    Type: 'String'

  LogGroupId:
    Type: 'String'

  AuthorizerFunctionId:
    Type: 'String'
  ResponderFunctionId:
    Type: 'String'
  ValidatorFunctionId:
    Type: 'String'

  DynamoTableName:
    Type: 'String'
  DynamoTableArn:
    Type: 'String'
  S3BucketArn:
    Type: 'String'
  SqsQueueArn:
    Type: 'String'

Resources:
  {% for lambda_dict in imported.API_LAMBDAS %}
  # -----------------------------------------------------------
  # Identitity and Access Management (IAM)
  #   See: https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/AWS_IAM.html
  #
  # Build out custom roles for each Lambda so that it only has access to the things it needs
  # -----------------------------------------------------------
  {{lambda_dict['name']}}Role:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: 'Allow'
            Principal:
              Service: 'lambda.amazonaws.com'
            Action:
              - 'sts:AssumeRole'
      ManagedPolicyArns:
        # Allow this Lambda to write to CloudWatch
        - 'arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole'
        # Allow this Lambda to invoke other Lambdas
        - 'arn:aws:iam::aws:policy/service-role/AWSLambdaRole'
      Policies:
        {% if lambda_dict['dynamo']|length > 0 %}
        - PolicyName: '{{lambda_dict['name']}}DynamoPolicy'
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              Effect: 'Allow'
              Action:
                - 'dynamodb:GetItem'
                {% if 'write' in lambda_dict['dynamo'] %}
                - 'dynamodb:DeleteItem'
                - 'dynamodb:PutItem'
                - 'dynamodb:UpdateItem'
                - 'dynamodb:BatchWriteItem'
                - 'dynamodb:PartiQLDelete'
                - 'dynamodb:PartiQLInsert'
                - 'dynamodb:PartiQLUpdate'
                {% endif %}
                {% if 'search' in lambda_dict['dynamo'] %}
                - 'dynamodb:BatchGetItem'
                - 'dynamodb:Describe*'
                - 'dynamodb:List*'
                - 'dynamodb:GetItem'
                - 'dynamodb:Query'
                - 'dynamodb:PartiQLSelect'
                {% endif %}
              Resource:
                - !Ref DynamoTableArn
                - !Sub '${DynamoTableArn}/index/*'
        {% endif %}

        {% if lambda_dict['s3']|length > 0 %}
        - PolicyName: '{{lambda_dict['name']}}S3Policy'
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              Effect: 'Allow'
              Action:
                - 's3:Get*'
                - 's3:List*'
                - 's3-object-lambda:Get*'
                - 's3-object-lambda:List*'
                {% if 'write' in lambda_dict['dynamo'] %}
                - 's3:PutObject'
                - 's3:DeleteObject'
                - 's3-object-lambda:PutObject'
                - 's3-object-lambda:DeleteObject'
                {% endif %}
              Resource: !Ref S3BucketArn
        {% endif %}

        {% if lambda_dict['sqs']|length > 0 %}
        - PolicyName: '{{lambda_dict['name']}}SqsQueuePolicy'
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              Effect: 'Allow'
              Action:
                - 'sqs:DeleteMessage'
                - 'sqs:ReceiveMessage'
                - 'sqs:SendMessage'
                - 'sqs:GetQueueAttributes'
                - 'sqs:GetQueueUrl'
                - 'sqs:ListDeadLetterSourceQueues'
                - 'sqs:ListQueues'
              Resource: !Ref SqsQueueArn
        {% endif %}

  # -----------------------------------------------------------
  # Lambda Function
  #   See: https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-lambda-function.html
  # -----------------------------------------------------------
  {{lambda_dict['name']}}Function:
    Type: 'AWS::Lambda::Function'
    DependsOn:
      - {{lambda_dict['name']}}Role
    Properties:
      Code:
        # Change this to the destination bucket once code signing is setup
        # Also update the build.sh to do the code signing via CLI
        S3Bucket: !Ref S3LambdaCodeSigningBucketId
        S3Key: !Sub '${Env}-{{lambda_dict['tag']}}-lambda.zip'
      # CodeSigningConfigArn: LambdaCodeSigningConfigArn
      Handler: 'lambda_function.LambdaFunctions::Handler.process'
      PackageType: 'Zip'
      Role: !GetAtt {{lambda_dict['name']}}Role.Arn
      Runtime: 'ruby2.7'
      Timeout: 30
      # TODO: This isn't working, so maybe stuff them in SSM and have the Lambda fetch them there
      Environment:
        Variables:
          DMP_ID_BASE_URL: !Sub 'api.${DomainName}/'
          DMP_ID_SHOULDER: !Ref DmpIdShoulder
          ENVIRONMENT: !Ref Env
          LAMBDA_AUTHORIZER: !Ref AuthorizerFunctionId
          LAMBDA_RESPONDER: !Ref ResponderFunctionId
          LAMBDA_VALIDATOR: !Ref ValidatorFunctionId
          {% if lambda_dict['dynamo']|length > 0 %}
          AWS_DYNAMO_TABLE_NAME: !Ref DynamoTableName
          {% endif %}
          {% if lambda_dict['s3']|length > 0 %}
          {% if 'write' in lambda_dict['s3'] %}
          {% endif %}
          {% endif %}
          {% if lambda_dict['sqs']|length > 0 %}
          {% if 'write' in lambda_dict['sqs'] %}
          {% endif %}
          {% endif %}

  # -----------------------------------------------------------
  # Lambda Version
  #   See: https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-lambda-version.html
  # -----------------------------------------------------------
  {{lambda_dict['name']}}Version:
    Type: 'AWS::Lambda::Version'
    Properties:
      Description: 'Initial version'
      FunctionName: !Ref {{lambda_dict['name']}}Function

  # -----------------------------------------------------------
  # Lambda Alias
  #   See: https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-lambda-alias.html
  # -----------------------------------------------------------
  {{lambda_dict['name']}}FunctionAlias:
    Type: 'AWS::Lambda::Alias'
    Properties:
      Name: !Sub '${Env}-{{lambda_dict['tag']}}-latest'
      FunctionName: !Ref {{lambda_dict['name']}}Function
      FunctionVersion: '$LATEST'

  # -----------------------------------------------------------
  # CodeBuild
  #   See: https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/AWS_CodeBuild.html
  # -----------------------------------------------------------
  {{lambda_dict['name']}}CodeBuildProject:
    Type: 'AWS::CodeBuild::Project'
    DependsOn:
      - {{lambda_dict['name']}}FunctionAlias
    Properties:
      ServiceRole: !Ref CodeBuildIAMRoleArn
      Artifacts:
        Type: 'CODEPIPELINE'
      LogsConfig:
        CloudWatchLogs:
          GroupName: !Ref LogGroupId
          Status: 'ENABLED'
          StreamName: 'codebuild-{{lambda_dict['tag']}}'
      Environment:
        Type: 'LINUX_CONTAINER'
        ComputeType: 'BUILD_GENERAL1_SMALL'
        Image: 'aws/codebuild/amazonlinux2-x86_64-standard:4.0'
        # This is required in order for the Docker daemon to work!
        PrivilegedMode: true
        EnvironmentVariables:
          - Name: 'LAMBDA_ENVIRONMENT'
            Value: !Ref Env
          - Name: 'LAMBDA_NAME'
            Value: '{{lambda_dict['tag']}}'
          - Name: 'LAMBDA_ARN'
            Value: !GetAtt {{lambda_dict['name']}}Function.Arn
          - Name: 'LAMBDA_ID'
            Value: !Ref {{lambda_dict['name']}}Function
          - Name: 'LAMBDA_ALIAS'
            Value: !Sub '${Env}-{{lambda_dict['tag']}}-latest'
          - Name: 'CURRENT_VERSION'
            Value: !GetAtt {{lambda_dict['name']}}Version.Version
          - Name: 'S3_BUCKET'
            Value: !Ref S3RepositoryBucket
      Source:
        Type: 'CODEPIPELINE'
        BuildSpec: 'buildspec.yaml'
      TimeoutInMinutes: 15
      VpcConfig:
        VpcId: !Ref VpcId
        Subnets: !Ref Subnets
        SecurityGroupIds:
          - !Ref CodeBuildSecurityGroupId
      Cache:
        Type: 'S3'
        Location: !Sub '${S3CodePipelineBucket}/build-cache'

  # -----------------------------------------------------------
  # CodePipeline
  #   See: https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-codepipeline-pipeline.html
  # -----------------------------------------------------------
  {{lambda_dict['name']}}Pipeline:
    Type: 'AWS::CodePipeline::Pipeline'
    DependsOn:
      - {{lambda_dict['name']}}CodeBuildProject
      # - {{lambda_dict['name']}}CodeDeployGroup
    Properties:
      ArtifactStore:
        Location: !Ref S3CodePipelineBucket
        Type: 'S3'
      RestartExecutionOnUpdate: true
      RoleArn: !Ref CodePipelineIAMRoleArn
      Stages:
        - Name: 'MonitorRepo'
          Actions:
            - Name: 'GitHub'
              RunOrder: 1
              ActionTypeId:
                Category: 'Source'
                Owner: 'AWS'
                Provider: 'CodeStarSourceConnection'
                Version: '1'
              # See: https://docs.aws.amazon.com/codepipeline/latest/userguide/action-reference-CodestarConnectionSource.html
              # for info on tying CodeBuild in
              Configuration:
                ConnectionArn: !Ref CodeStarConnectionArn
                FullRepositoryId: 'CDLUC3/dmphub-v2-{{lambda_dict['tag']}}-lambda'
                BranchName: !Ref RepositoryBranchToMonitor
                OutputArtifactFormat: 'CODEBUILD_CLONE_REF'
              OutputArtifacts:
                - Name: '{{lambda_dict['tag']}}-commit'

        - Name: 'BuildPublish'
          Actions:
            - Name: 'ZipToS3'
              RunOrder: 2
              ActionTypeId:
                Category: 'Build'
                Owner: 'AWS'
                Provider: 'CodeBuild'
                Version: '1'
              Configuration:
                ProjectName: !Ref {{lambda_dict['name']}}CodeBuildProject
                PrimarySource: '{{lambda_dict['tag']}}-commit'
              InputArtifacts:
                - Name: '{{lambda_dict['tag']}}-commit'
              OutputArtifacts:
                - Name: '{{lambda_dict['tag']}}-appspec'
  {% endfor %}

Outputs:
  {% for lambda_dict in imported.API_LAMBDAS %}
  {{lambda_dict['name']}}RoleId:
    Value: !Ref {{lambda_dict['name']}}Role

  {{lambda_dict['name']}}FunctionId:
    Value: !Ref {{lambda_dict['name']}}Function
  {{lambda_dict['name']}}FunctionArn:
    Value: !GetAtt {{lambda_dict['name']}}Function.Arn

  {{lambda_dict['name']}}AliasArn:
    Value: !Ref {{lambda_dict['name']}}FunctionAlias

  {{lambda_dict['name']}}VersionArn:
    Value: !Ref {{lambda_dict['name']}}Version
  {{lambda_dict['name']}}Version:
    Value: !GetAtt {{lambda_dict['name']}}Version.Version

  {{lambda_dict['name']}}CodeBuildProjectName:
    Value: !Ref {{lambda_dict['name']}}CodeBuildProject
  {{lambda_dict['name']}}CodeBuildProjectArn:
    Value: !GetAtt {{lambda_dict['name']}}CodeBuildProject.Arn

  {{lambda_dict['name']}}PipelineId:
    Value: !Ref {{lambda_dict['name']}}Pipeline
  {{lambda_dict['name']}}PipelineVersion:
    Value: !GetAtt {{lambda_dict['name']}}Pipeline.Version
  {% endfor %}