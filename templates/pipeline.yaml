AWSTemplateFormatVersion: '2010-09-09'
Transform: 'AWS::Serverless-2016-10-31'

Description: 'Code build and pipeline for the DMPRoadmap system'

Parameters:
  VpcId:
    Type: 'AWS::EC2::VPC::Id'
  Subnets:
    Type: 'List<AWS::EC2::Subnet::Id>'

  Env:
    Type: 'String'
    Default: 'dev'

  ProgramTag:
    Type: 'String'
  ServiceTag:
    Type: 'String'
  SubserviceTag:
    Type: 'String'
  CodeRepoTag:
    Type: 'String'
  ContactTag:
    Type: 'String'

  CodeStarConnectionArn:
    Type: 'String'

  S3CloudFrontBucketId:
    Type: 'String'
  CloudFrontDistroId:
    Type: 'String'

  S3ArtifactBucketId:
    Type: 'String'
  S3LogBucketId:
    Type: 'String'

  CodeBuildEmail:
    Type: 'String'
  SnsTopicEmailArn:
    Type: 'String'

  LogRetentionDays:
    Type: 'Number'
    Default: 7

  CodeBuildEnvironmentType:
    Type: 'String'
    Default: 'LINUX_CONTAINER'
  CodeBuildEnvironmentComputeType:
    Type: 'String'
    Default: 'BUILD_GENERAL1_SMALL'
  CodeBuildEnvironmentImage:
    Type: 'String'
    Default: 'aws/codebuild/amazonlinux2-x86_64-standard:4.0'
  CodeBuildArtifactType:
    Type: 'String'
    Default: 'CODEPIPELINE'
  CodeBuildTimeout:
    Type: 'Number'
    Default: 15 # minutes

  CodePipelineRestartExecutionOnUpdate:
    Type: 'String'
    Default: 'true'
    AllowedValues:
      - 'true'
      - 'false'
  CodePipelineRepositoryName:
    Type: 'String'
  CodePipelineBranchToMonitor:
    Type: 'String'
    Default: 'main'
  CodePipelineSourceOutputArtifactFormat:
    Type: 'String'
    Default: 'CODEBUILD_CLONE_REF'
  CodePipelineDeploymentTimeout:
    Type: 'String'
    Default: '15'
  CodePipelineBuildArtifactFileName:
    Type: 'String'
    Default: 'imagedefinitions.json'

Resources:
  # -----------------------------------------------------------
  # Identitity and Access Management (IAM)
  #   See: https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/AWS_IAM.html
  # -----------------------------------------------------------
  IamPipelineRole:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: 'Allow'
            Principal:
              Service:
                - 'codepipeline.amazonaws.com'
            Action:
              - 'sts:AssumeRole'
      Policies:
        - PolicyName: !Sub '${AWS::StackName}-pipline-policy'
          PolicyDocument: !Sub >
            {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": ["codestar-connections:UseConnection"],
                  "Resource": "${CodeStarConnectionArn}"
                }
              ]
            }
      ManagedPolicyArns:
        - 'arn:aws:iam::aws:policy/AWSCodePipeline_FullAccess'
        - 'arn:aws:iam::aws:policy/AmazonS3FullAccess'
        - 'arn:aws:iam::aws:policy/AWSCodeBuildDeveloperAccess'
        - 'arn:aws:iam::aws:policy/AmazonECS_FullAccess'
        - 'arn:aws:iam::aws:policy/CloudWatchLogsFullAccess'

  IamCodeBuildRole:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: 'Allow'
            Principal:
              Service: 'codebuild.amazonaws.com'
            Action:
              - 'sts:AssumeRole'
      ManagedPolicyArns:
        - 'arn:aws:iam::aws:policy/AmazonS3FullAccess'
        - 'arn:aws:iam::aws:policy/EC2InstanceProfileForImageBuilderECRContainerBuilds'
      Policies:
        - PolicyName: !Sub '${AWS::StackName}-build-policy'
          PolicyDocument: !Sub >
            {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": [
                    "logs:CreateLogGroup",
                    "logs:CreateLogStream",
                    "logs:PutLogEvents",
                    "logs:AssociateKmsKey"
                  ],
                  "Resource": [
                    "${PipelineLogGroup.Arn}"
                  ]
                },
                {
                  "Effect": "Allow",
                  "Action": [
                    "cloudwatch:PutMetricData"
                  ],
                  "Resource": [
                    "*"
                  ]
                },
                {
                  "Effect": "Allow",
                  "Action": [
                    "logs:*",
                    "ec2:CreateNetworkInterface",
                    "ec2:DescribeNetworkInterfaces",
                    "ec2:DeleteNetworkInterface",
                    "ec2:DescribeSubnets",
                    "ec2:DescribeSecurityGroups",
                    "ec2:DescribeDhcpOptions",
                    "ec2:DescribeVpcs",
                    "ec2:CreateNetworkInterfacePermission"
                  ],
                  "Resource": [
                    "*"
                  ]
                },
                {
                  "Effect": "Allow",
                  "Action": ["codestar-connections:UseConnection"],
                  "Resource": "${CodeStarConnectionArn}"
                },
                {
                  "Effect": "Allow",
                  "Action": [
                    "cloudfront:UpdateDistribution",
                    "cloudfront:DeleteDistribution",
                    "cloudfront:CreateInvalidation"
                  ],
                  "Resource": "arn:aws:cloudfront::${AWS::AccountId}:distribution/${CloudFrontDistroId}"
                },
                {
                  "Effect": "Allow",
                  "Action": [
                    "sns:Publish"
                  ],
                  "Resource": "${SnsTopicEmailArn}"
                }
              ]
            }

  # ----------------------------------------------------
  # CloudWatch LogGroup
  #   See: https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/AWS_Logs.html
  # ----------------------------------------------------
  PipelineLogGroup:
    Type: 'AWS::Logs::LogGroup'
    Properties:
      RetentionInDays: !Ref LogRetentionDays

  # -----------------------------------------------------------
  # CodeBuild
  #   See: https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/AWS_CodeBuild.html
  # -----------------------------------------------------------
  CodeBuildSecurityGroup:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupName: !Sub '${AWS::StackName}-build-sec'
      GroupDescription: !Sub '${AWS::StackName} CodeBuild SecurityGroup'
      VpcId: !Ref VpcId
      Tags:
        # This tag is required so that the SecurityGroup does not trigger alerts after the
        # CodeBuild process finishes and deprovisions the EC2 instance.
        - Key: 'ConfigExclude'
          Value: 'Security-group-attached-to-ENI'
        - Key: 'Program'
          Value: !Ref ProgramTag
        - Key: 'Service'
          Value: !Ref ServiceTag
        - Key: 'Subservice'
          Value: !Ref SubserviceTag
        - Key: 'Environment'
          Value: !Ref Env
        - Key: 'CodeRepo'
          Value: !Ref CodeRepoTag
        - Key: 'Contact'
          Value: !Ref ContactTag

  CodeBuildProject:
    Type: 'AWS::CodeBuild::Project'
    DependsOn:
      - CodeBuildSecurityGroup
    Properties:
      ServiceRole: !GetAtt IamCodeBuildRole.Arn
      Artifacts:
        Type: !Ref CodeBuildArtifactType
      LogsConfig:
        CloudWatchLogs:
          GroupName: !Ref PipelineLogGroup
          Status: 'ENABLED'
          StreamName: 'codebuild'
      Environment:
        Type: !Ref CodeBuildEnvironmentType
        ComputeType: !Ref CodeBuildEnvironmentComputeType
        Image: !Ref CodeBuildEnvironmentImage
        # This is required in order for the Docker daemon to work!
        PrivilegedMode: true
        EnvironmentVariables:
          - Name: 'S3_BUCKET'
            Value: !Ref S3CloudFrontBucketId
          - Name: 'CLOUDFRONT_DISTRO_ID'
            Value: !Ref CloudFrontDistroId
          - Name: 'SNS_EMAIL_TOPIC'
            Value: !Ref SnsTopicEmailArn
      Source:
        Type: !Ref CodeBuildArtifactType
      TimeoutInMinutes: !Ref CodeBuildTimeout
      VpcConfig:
        VpcId: !Ref VpcId
        Subnets: !Ref Subnets
        SecurityGroupIds:
          - !Ref CodeBuildSecurityGroup
      Cache:
        Type: 'S3'
        Location: !Sub '${S3ArtifactBucketId}/build-cache'

  # -----------------------------------------------------------
  # CodePipeline
  #   See: https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-codepipeline-pipeline.html
  # -----------------------------------------------------------
  Pipeline:
    Type: 'AWS::CodePipeline::Pipeline'
    DependsOn:
      - IamPipelineRole
    Properties:
      ArtifactStore:
        Location: !Ref S3ArtifactBucketId
        # CloudFormation only supports S3 at the moment!
        Type: 'S3'
      RestartExecutionOnUpdate: !Ref CodePipelineRestartExecutionOnUpdate
      RoleArn: !GetAtt IamPipelineRole.Arn
      Stages:
        - Name: 'MonitorRepo'
          Actions:
            # This action is triggered when the development branch of DMPRoadmap has a new commit
            # it's output is the commit hash
            - Name: 'DmpHubUi'
              RunOrder: 1
              ActionTypeId:
                Category: 'Source'
                Owner: 'AWS'
                Provider: 'CodeStarSourceConnection'
                Version: '1'
              # See: https://docs.aws.amazon.com/codepipeline/latest/userguide/action-reference-CodestarConnectionSource.html
              # for info on tying CodeBuild in
              Configuration:
                ConnectionArn: !Ref CodeStarConnectionArn
                FullRepositoryId: !Ref CodePipelineRepositoryName
                BranchName: !Ref CodePipelineBranchToMonitor
                OutputArtifactFormat: !Ref CodePipelineSourceOutputArtifactFormat
              OutputArtifacts:
                - Name: !Sub "${AWS::StackName}-code"

        - Name: 'DockerBuildPublish'
          Actions:
            # This action is triggered by either the DMPRoadmapPush or DockerPush actions. This
            # action uses the DMPRoadmapPush commit hash to the latest DockerPush zip to build
            # the Docker image
            - Name: 'DmpHubBuildDeploy'
              RunOrder: 2
              ActionTypeId:
                Category: 'Build'
                Owner: 'AWS'
                Provider: 'CodeBuild'
                Version: '1'
              # RoleArn: !GetAtt IamCodeBuildRole.Arn
              Configuration:
                ProjectName: !Ref CodeBuildProject
                PrimarySource: !Sub "${AWS::StackName}-code"
              InputArtifacts:
                - Name: !Sub "${AWS::StackName}-code"
              OutputArtifacts:
                - Name: !Sub "${AWS::StackName}-build"

Outputs:
  PipelineRoleId:
    Value: !Ref IamPipelineRole
  PipelineRoleArn:
    Value: !GetAtt IamPipelineRole.Arn

  CodeBuildRoleId:
    Value: !Ref IamCodeBuildRole
  CodeBuildRoleArn:
    Value: !GetAtt IamCodeBuildRole.Arn

  CodeBuildProjectName:
    Value: !Ref CodeBuildProject
  CodeBuildProjectArn:
    Value: !GetAtt CodeBuildProject.Arn

  PipelineId:
    Value: !Ref Pipeline
  PipelineVersion:
    Value: !GetAtt Pipeline.Version
