AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: Typeahead DynamoTable Stream function that manages the related OpenSearch
  indices
Parameters:
  Env:
    Type: String
    Default: dev
  DebugLevel:
    Type: String
    Default: debug
  LogRetentionDays:
    Type: Number
    Default: 14
  SubnetA:
    Type: AWS::EC2::Subnet::Id
  SubnetB:
    Type: AWS::EC2::Subnet::Id
  SubnetC:
    Type: AWS::EC2::Subnet::Id
  IndexerRoleArn:
    Type: String
  LambdaSecurityGroupId:
    Type: String
  OpenSearchSecurityGroupId:
    Type: String
  OpenSearchDomainEndpoint:
    Type: String
  BaselineLayerId:
    Type: String
  TypeaheadTableStreamArn:
    Type: String
  DeadLetterQueueArn:
    Type: String
Resources:
  Function:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: Function
      Handler: app.Functions::TypeaheadIndexer.process
      Runtime: ruby3.2
      Timeout: 600
      Architectures:
      - x86_64
      Layers:
      - Ref: BaselineLayerId
      Role:
        Ref: IndexerRoleArn
      Environment:
        Variables:
          LAMBDA_ENV:
            Ref: Env
          LOG_LEVEL:
            Ref: DebugLevel
          OPEN_SEARCH_DOMAIN:
            Fn::Sub: https://${OpenSearchDomainEndpoint}
      VpcConfig:
        SecurityGroupIds:
        - Ref: LambdaSecurityGroupId
        - Ref: OpenSearchSecurityGroupId
        SubnetIds:
        - Ref: SubnetA
        - Ref: SubnetB
        - Ref: SubnetC
      Events:
        DynamoDbOpenSearchEvent:
          Type: DynamoDB
          Properties:
            Enabled: true
            StartingPosition: TRIM_HORIZON
            Stream:
              Ref: TypeaheadTableStreamArn
            DestinationConfig:
              OnFailure:
                Destination:
                  Ref: DeadLetterQueueArn
    Metadata:
      SamResourceId: Function
  FunctionPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName:
        Ref: Function
      Action: lambda:InvokeFunction
      Principal: events.amazonaws.com
  LogGroup:
    Type: AWS::Logs::LogGroup
    DependsOn:
    - Function
    Properties:
      LogGroupName:
        Fn::Sub: /aws/lambda/${Function}
      RetentionInDays:
        Ref: LogRetentionDays
Outputs:
  FunctionId:
    Value:
      Ref: Function
  FunctionArn:
    Value:
      Fn::GetAtt:
      - Function
      - Arn
  LogGroupId:
    Value:
      Ref: LogGroup
  LogGroupArn:
    Value:
      Fn::GetAtt:
      - LogGroup
      - Arn
